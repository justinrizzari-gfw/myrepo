---
title: "Data training questions"
author: "Cian Luck"
date: "15 Sep 2021"
output:
  html_notebook:
    df_print: default
    highlight: pygments
    toc: yes
    toc_float:
      toc_collapsed: true
    toc_depth: 2
subtitle: Hannah's revamped training questions
editor_options:
  chunk_output_type: inline
---

**WORK IN PROGRESS**

# Voyages/Port Visits

## 1. How many voyages did Tuna Queen have in 2019 based on a port visit confidence of 4?

```{r}
query_10 <- glue_sql(
  "
  ---------------------------------------------------------------------
-- Query: How many voyages did 'Tuna Queen' have in 2018 with a 
-- port confidence of 4?
--
-- Author: Cian Luck
-- Date: 15 Oct 2021
---------------------------------------------------------------------

WITH 

    -----------------------------------------------------------------
    -- vessel info
    -----------------------------------------------------------------
    vessel_info AS(
        SELECT
            ssvid,
            year,
            ais_identity.shipname_mostcommon.value as shipname,
            best.best_flag,
            best.best_vessel_class
        FROM 
            `world-fishing-827.gfw_research.vi_ssvid_byyear_v20210913`
        WHERE 
            ais_identity.shipname_mostcommon.value = 'TUNA QUEEN'
    ),

    -----------------------------------------------------------------
    -- voyages confidence 4
    -----------------------------------------------------------------
    voyages_c4 AS(
        SELECT 
            ssvid, 
            trip_id,
            trip_start,
            trip_end,
            trip_start_confidence,
            trip_end_confidence,
            EXTRACT(year FROM trip_start) AS year
        FROM 
            `world-fishing-827.pipe_production_v20201001.proto_voyages_c4`
        WHERE 
            DATE(trip_start) BETWEEN '2018-01-01' AND '2018-12-31' 
            AND DATE(trip_end) BETWEEN '2018-01-01' AND '2018-12-31' 
    ),

    -----------------------------------------------------------------
    -- Tuna Queen voyages
    -----------------------------------------------------------------
    vessel_voyages AS(
        SELECT *
        FROM vessel_info
        JOIN voyages_c4
            USING(ssvid, year)
    )

------------------------------------------------------------
-- Return vessel_voyages
------------------------------------------------------------
SELECT *
FROM vessel_voyages
  "
)
```



```{r}
tuna_queen_voyages_2018 <- fishwatchr::gfw_query(query = query_10,
                                                 run_query = TRUE,
                                                 con = con)$data
```

Answer: `r n_distinct(tuna_queen_voyages_2018$trip_id)` (32)
 
## 2. How does this number change if you restrict confidence to at least 2 or at least 3?

```{r}
query_11 <- glue_sql(
  "
  ---------------------------------------------------------------------
-- Query: How many voyages did 'Tuna Queen' have in 2018 with a 
-- port confidence of 4?
--
-- Author: Cian Luck
-- Date: 15 Oct 2021
---------------------------------------------------------------------

WITH 

    -----------------------------------------------------------------
    -- vessel info
    -----------------------------------------------------------------
    vessel_info AS(
        SELECT
            ssvid,
            year,
            ais_identity.shipname_mostcommon.value as shipname,
            best.best_flag,
            best.best_vessel_class
        FROM 
            `world-fishing-827.gfw_research.vi_ssvid_byyear_v20210913`
        WHERE 
            ais_identity.shipname_mostcommon.value = 'TUNA QUEEN'
    ),

    -----------------------------------------------------------------
    -- voyages confidence 2
    -----------------------------------------------------------------
    voyages_c4 AS(
        SELECT 
            ssvid, 
            trip_id,
            trip_start,
            trip_end,
            trip_start_confidence,
            trip_end_confidence,
            EXTRACT(year FROM trip_start) AS year
        FROM 
            `world-fishing-827.pipe_production_v20201001.proto_voyages_c2`
        WHERE 
            DATE(trip_start) BETWEEN '2018-01-01' AND '2018-12-31' 
            OR DATE(trip_end) BETWEEN '2018-01-01' AND '2018-12-31' 
    ),

    -----------------------------------------------------------------
    -- Tuna Queen voyages
    -----------------------------------------------------------------
    vessel_voyages AS(
        SELECT *
        FROM vessel_info
        JOIN voyages_c4
            USING(ssvid, year)
    )

------------------------------------------------------------
-- Return vessel_voyages
------------------------------------------------------------
SELECT *
FROM vessel_voyages
  "
)
```



```{r}
tuna_queen_voyages_2018 <- fishwatchr::gfw_query(query = query_11,
                                                 run_query = TRUE,
                                                 con = con)$data
```

```{r}
n_distinct(tuna_queen_voyages_2018$trip_id)
```

N voyages (confidence >= 3) = 33
N voyages (confidence >= 2) = 33

## 3. How many port events occurred in the port visit associated with the voyage that ended in Zadar on January 20, 2018?
 
```{r}
query_12 <- glue_sql(
  "
  ---------------------------------------------------------------------
-- Query: How many port events occurred in the port visit associated 
-- with the voyage that ended in Zadar on 20 Jan 2018?
--
-- Author: Cian Luck
-- Date: 15 Oct 2021
---------------------------------------------------------------------

WITH 

    -----------------------------------------------------------------
    -- find anchorage called Zadar
    -----------------------------------------------------------------
    anchorage_zadar AS (
        SELECT 
            s2id,
            label,
            sublabel
        FROM 
            `world-fishing-827.gfw_research.named_anchorages`
        WHERE 
            label = 'ZADAR' 
            OR sublabel = 'ZADAR'
    ),

    -----------------------------------------------------------------
    -- voyage ending in Zadar on 20 Jan 2018
    -- this returns 14 voyages
    -----------------------------------------------------------------
    -- voyages AS (
    --     SELECT 
    --         *
    --     FROM 
    --        `world-fishing-827.gfw_research.voyages_no_overlapping_short_seg_v20210226`
    --     WHERE 
    --         DATE(trip_end) = '2018-01-20'
    --         AND trip_end_anchorage_id IN (
    --             SELECT s2id
    --             FROM anchorage_zadar
    --         )
    -- ),

    voyages AS (
        SELECT 
            *
        FROM 
           `world-fishing-827.pipe_production_v20201001.proto_voyages_c4`
        WHERE 
            DATE(trip_end) = '2018-01-20'
            AND trip_end_confidence >= 4
            AND trip_end_anchorage_id IN (
                SELECT s2id
                FROM anchorage_zadar
            )
    ),

    -----------------------------------------------------------------
    -- port events associated with these voyages
    -----------------------------------------------------------------
    events AS (
        SELECT 
            visit_id,
            events
        FROM 
           `world-fishing-827.pipe_production_v20201001.proto_port_visits`
        LEFT JOIN UNNEST(events)
        WHERE  
            DATE(end_timestamp) = '2018-01-20'
            AND visit_id IN (
                SELECT trip_end_visit_id
                FROM voyages
            )
    )

-----------------------------------------------------------------
-- return voyages
-----------------------------------------------------------------
SELECT * 
FROM events
  "
)
```


```{r}
zadar_events <- fishwatchr::gfw_query(query = query_12,
                                      run_query = TRUE,
                                      con = con)$data
```

Answer: `r nrow(zadar_events)` (30)
 
## 4. What is the count of port visits per port based on the end of the voyages in 2018 for Tuna Queen (based on a confidence of 3 and for the 'right' Tuna Queen)?

```{r}
query_13 <- glue_sql(
  "
  ---------------------------------------------------------------------
-- Query: Count of port visits per port based on end of voyages in
-- 2018 (confidence >= 3, and 'right' Tuna Queen)
--
-- Author: Cian Luck
-- Date: 16 Sep 2021
---------------------------------------------------------------------

WITH 

    -----------------------------------------------------------------
    -- vessel info
    -- only one vessel active as the Tuna Queen 9n 2018 (ssvid 352894000)
    -----------------------------------------------------------------
    vessel_info AS(
        SELECT
            ssvid,
            year,
            ais_identity.shipname_mostcommon.value as shipname,
            best.best_flag,
            best.best_vessel_class
        FROM 
            `world-fishing-827.gfw_research.vi_ssvid_byyear_v20210913`
        WHERE 
            ais_identity.shipname_mostcommon.value = 'TUNA QUEEN'
    ),

    -----------------------------------------------------------------
    -- voyages confidence 3
    -- which voyages ended in 2018?
    -----------------------------------------------------------------
    voyages_c3 AS(
        SELECT 
            ssvid, 
            trip_id,
            trip_end,
            trip_end_confidence,
            trip_end_visit_id,
            EXTRACT(year FROM trip_start) AS year
        FROM 
            `world-fishing-827.pipe_production_v20201001.proto_voyages_c3`
        WHERE 
            trip_end_confidence >= 3
            AND DATE(trip_end) BETWEEN '2018-01-01' AND '2018-12-31'
    ),

    -----------------------------------------------------------------
    -- Tuna Queen voyages
    -----------------------------------------------------------------
    vessel_voyages AS(
        SELECT *
        FROM vessel_info
        JOIN voyages_c3
            USING(ssvid, year)
    ),

    -----------------------------------------------------------------
    -- port events associated with these voyages
    -----------------------------------------------------------------
    events AS (
        SELECT 
            *
        FROM 
           `world-fishing-827.pipe_production_v20201001.proto_port_visits`
        WHERE  
            DATE(end_timestamp) BETWEEN '2018-01-01' AND '2018-12-31'
            AND visit_id IN (
                SELECT trip_end_visit_id
                FROM vessel_voyages
            )
    )

------------------------------------------------------------
-- Return events
------------------------------------------------------------
SELECT *
FROM events
  "
)
```


```{r}
tuna_queen_visits_2018 <- fishwatchr::gfw_query(query = query_13,
                                      run_query = TRUE,
                                      con = con)$data
```

**Count** of port **visits** **per port** based on **end of voyages** in **2018** (confidence >= 3 and 'right' Tuna Queen)

```{r}
tuna_queen_visits_2018 %>% 
  filter(confidence >= 3) %>%
  group_by(end_anchorage_id) %>% 
  summarise(n_visits = n_distinct(visit_id)) %>% 
  arrange(desc(n_visits))
```

## 5.

```{r}
query_14 <- glue_sql(
  "
-------------------------------------------------------------
-- Query: What ports were visited by carriers in IOTC in 2020
-- after loitering events? How many port visits occurred at
-- each port?
--
-- Author: Cian Luck
-- Date: 16 Sep 2021
-------------------------------------------------------------

-- First task: pull loitering events
-- Second: id ports
-- Third: visits per port


WITH
    --------------------------------------------------------
    -- Restrict to carrier vessels using the vessel database
    --------------------------------------------------------
    carrier_vessels as(
        SELECT 
            mmsi AS ssvid,
            year,
            flag,
            vessel_class
        FROM 
            `vessel_database.carrier_vessels_byyear_v20210701`
        WHERE
            year = 2020
    ),

    --------------------------------------------------------
    -- Load shapefile of IOTC
    --------------------------------------------------------
    iotc AS (
        SELECT
        -- note: had to add make_valid => TRUE as seems to be a problem with the shapefile
            ST_GEOGFROMTEXT(string_field_1, make_valid => TRUE) AS polygon 
        FROM
            `world-fishing-827.ocean_shapefiles_all_purpose.IOTC_shape_feb2021`
    ), 

    --------------------------------------------------------    
    -- Filter loitering events to those that are at least 20-nm from shore
    -- and are loitering for at least 4 hours
    -- Also filter for good segments that are not overlapping and short using gfw_research.pipe_v_segs
    -- Adjust desired timeframe
    -- Filter only locations within IOTC
    --------------------------------------------------------
    loitering AS(
        SELECT
            ssvid,
            seg_id,
            loitering_start_timestamp,
            loitering_end_timestamp,
            loitering_hours,
        FROM
            `pipe_production_v20201001.loitering`, iotc
        WHERE
            avg_distance_from_shore_nm >= 20
            AND loitering_hours >= 4
            AND loitering_hours < 24
            AND avg_speed_knots < 2
            AND seg_id IN (
                SELECT
                    seg_id
                FROM
                    `gfw_research.pipe_v20201001_segs`
                WHERE
                    good_seg
                    AND NOT overlapping_and_short)
            AND loitering_start_timestamp >= TIMESTAMP('2020-01-01')
            AND loitering_end_timestamp <= TIMESTAMP('2020-12-31')
            AND ST_CONTAINS(iotc.polygon, ST_GEOGPOINT(start_lon, start_lat))
            AND ssvid IN (
                SELECT
                    ssvid
                FROM
                    carrier_vessels)
    ),

    --------------------------------------------------------
    -- Join loitering_events
    -- This is what I would return for a loitering query
    -------------------------------------------------------- 
    loitering_events AS(
        SELECT
            ssvid,
            seg_id,
            flag,
            loitering_start_timestamp,
            loitering_end_timestamp,
            loitering_hours,
        FROM
            loitering
        LEFT JOIN
            carrier_vessels
        USING
            (ssvid)
        ORDER BY
            ssvid,
            seg_id,
            loitering_start_timestamp
    ),

    -----------------------------------------------------------------
    -- voyages confidence 4
    -----------------------------------------------------------------
    voyages_c4 AS(
        SELECT 
            ssvid, 
            trip_id,
            trip_start,
            trip_end,
            trip_end_confidence,
            trip_end_visit_id,
            EXTRACT(year FROM trip_start) AS year
        FROM 
            `world-fishing-827.pipe_production_v20201001.proto_voyages_c4`
        WHERE 
            trip_end_confidence >= 4
            AND DATE(trip_end) BETWEEN '2020-01-01' AND '2020-12-31'
    ),

    -----------------------------------------------------------------
    -- join loitering and voyages_c4
    -- conditional trip_end >= loitering_end_timestamp
    -----------------------------------------------------------------
    voyages_post_loitering AS(
        SELECT 
            *
        FROM(
            SELECT * 
            FROM voyages_c4  
        ) a            
        JOIN (
            SELECT
                ssvid,
                loitering_end_timestamp,
                loitering_start_timestamp
            FROM loitering_events 
        ) b
            ON a.ssvid = b.ssvid
            AND a.trip_end >= b.loitering_end_timestamp
            AND a.trip_start <= b.loitering_start_timestamp
    ),

    -----------------------------------------------------------------
    -- keep only the minimum date post each loitering event
    -----------------------------------------------------------------
    voyages_post_loitering_min AS(
        SELECT 
            v1.*
        FROM voyages_post_loitering v1
        JOIN (
            SELECT 
                trip_id,
                MIN(trip_end) AS trip_end
            FROM voyages_post_loitering 
            GROUP BY trip_id
        ) v2
            USING(trip_id, trip_end)
    ),

    -----------------------------------------------------------------
    -- port visits associated with these voyages
    -----------------------------------------------------------------
    visits AS (
        SELECT 
            *
        FROM 
           `world-fishing-827.pipe_production_v20201001.proto_port_visits`
        WHERE  
            DATE(end_timestamp) BETWEEN '2020-01-01' AND '2020-12-31'
            AND visit_id IN (
                SELECT trip_end_visit_id
                FROM voyages_post_loitering_min
            )
    ),

    -----------------------------------------------------------------
    -- count visits per port
    -----------------------------------------------------------------
    visits_sum AS(
        SELECT 
            end_anchorage_id,
            COUNT(DISTINCT visit_id) AS n_visits
        FROM visits
        WHERE confidence >= 4
        GROUP BY end_anchorage_id
        ORDER BY n_visits DESC
    )





-------------------------------------------------------------
-- Return
-------------------------------------------------------------
SELECT *
FROM visits_sum
  "
)
```


```{r}
visits_post_loitering <- fishwatchr::gfw_query(query = query_14,
                                               run_query = TRUE,
                                               con = con)$data
```