---
title: "Homework"
---

load libraries

```{r load libraries}

library(bigrquery)
library(fishwatchr)
library(tinytex)
library(sp)
library(ggmap)
library(devtools)
library(ggplot2)
library(dplyr)
library(scales)
library(rgeos)
library(rgdal)  
library(grid)
library(cowplot)
library(knitr)
library(bigrquery)
library(tidyverse)
library(sf)
library(s2)

library(knitr)
library(reshape2)
library(flextable)
library(officer)
library(countrycode)
library(rnaturalearthhires)
library(rgeos)
sf::sf_use_s2(FALSE)


BQ_connection <-  dbConnect(bigquery(), project = "world-fishing-827", use_legacy_sql = FALSE)
con <- DBI::dbConnect(drv = bigrquery::bigquery(), project = "world-fishing-827", use_legacy_sql = FALSE)

```

----- Vessel Track Questions---

Question 1. Plot the track for MMSI 352894000 from October 24th 2017 - November 6 2017 without any filters to ‘clean’ the data

Answer: Unfitlered track plotted below -- we clearly see a jump in latitude and speed between the 27th and 30th of November.

```{r Questions 1.}

track_no_filters <- glue::glue("SELECT 
ssvid,
lon,
lat,
timestamp,
speed_knots, 
-1 * elevation_m AS depth_m,
distance_from_shore_m/1000 AS distance_from_shore_km,
nnet_score
FROM
`world-fishing-827.gfw_research.pipe_v20201001` 
--WHERE seg_id IN (
--SELECT seg_id 
-- `gfw_research.pipe_v20201001_segs` 
WHERE 
--overlapping_and_short IS FALSE AND 
--good_seg IS TRUE) AND
ssvid = '352894000' AND
_partitiontime BETWEEN TIMESTAMP('2017-10-24') AND TIMESTAMP('2017-11-06') 
--AND nnet_score IS NOT NULL
ORDER BY timestamp
")


track_no_filters<- gfw_query(query = track_no_filters, run_query = TRUE, con = con)


fishing_track_review(track_df = track_no_filters$data,
                     color_fishing = TRUE,
                     globe_location = 'upperright',
                     time_series_labels = c('lat','speed_knots'),
                     vessel_name = 'TUNAQUEEN')

```


Questions 2. Based on what you are seeing, investigate the connection between, ssvid, vessel id, and seg_id during the time the track seems to make less sense using tables `pipe_production_v20201001.segment_info` and `world-fishing-827.gfw_research.pipe_v20201001_segs`. Can you identify what is occurring in the data to cause the wonky tracks?

Answer: 
- Looking at the seg_info table it appears that between the 27th and the 30th of November the vessel pinged messages with a different identity than the TUNAQUEEN which is the most common and for which we see more than 1000 identity counts. A vessel using the same MMSI as the TUNAQUEEN but called ANNELLY pinged in SURABAYA port (in Indonesia on East Java Island).

- Looking at the seg_table it seems that on the 27th of October there are neither goodseg nor goodseg2 meaning that the segment had less than 5 positions and was not moving. In addition to this, the segment had overlapping_and_short = TRUE was overlapping with shorter than another segment. On the 30th of October was not overlapping and short, possibly meaning that the TUNAQUEEN was not pinging at all than and thus segment were not overlapping, also the segment had less than 10 position as goodseg2=TRUE but goodseg =FALSE. On the 23rd of November the segment looked good again (it had more than 5 position and was moving and was not overlapping and short).

```{r Question 2.}

#check pipe_production_v20201001.segment_info table  

seg_info_inspect <- glue::glue("

SELECT 
*
FROM `world-fishing-827.pipe_production_v20201001.segment_info` 
WHERE
ssvid IN ('352894000')
AND first_timestamp  >= ('2017-10-24')
AND last_timestamp <= ('2017-11-25') 

")


seg_info_inspect<- gfw_query(query = seg_info_inspect, run_query = TRUE, con = con)

a<-seg_info_inspect$data
a

#world-fishing-827.gfw_research.pipe_v20201001_segs

seg_pipe_inspect <- glue::glue("

SELECT 
ssvid,
min_lat,
min_lon,
max_lon,
max_lat,
first_timestamp,
last_timestamp,
good_seg,
good_seg2,
overlapping_and_short
FROM `world-fishing-827.gfw_research.pipe_v20201001_segs`
WHERE
ssvid = '352894000'
AND
first_timestamp BETWEEN timestamp('2017-10-24') AND timestamp('2017-11-25')
ORDER BY
first_timestamp
")


seg_pipe_inspect<- gfw_query(query = seg_pipe_inspect, run_query = TRUE, con = con)

b<-seg_pipe_inspect$data
b


```


Question 3. Plot the track for MMSI 352894000 from October 24th 2017 - November 6 2017 again but removing noise. 

```{r Question 3. }
track_filtered <- glue::glue("SELECT 
ssvid,
lon,
lat,
timestamp,
speed_knots, 
-1 * elevation_m AS depth_m,
distance_from_shore_m/1000 AS distance_from_shore_km,
nnet_score
FROM
`gfw_research.pipe_v20201001` 
WHERE seg_id IN (
SELECT seg_id 
FROM `gfw_research.pipe_v20201001_segs` 
WHERE 
overlapping_and_short IS FALSE AND 
good_seg IS TRUE) AND
ssvid = '352894000' AND
_partitiontime BETWEEN TIMESTAMP('2017-10-24') AND TIMESTAMP('2017-11-06') AND
nnet_score IS NOT NULL
ORDER BY timestamp")


track_filtered<- gfw_query(query = track_filtered, run_query = TRUE, con = con)

track_filtered<- track_filtered$data

bounding <- transform_box(xlim = c(min(track_filtered$lon) - 10,
                                               max(track_filtered$lon) + 10),
                                      ylim = c(min(track_filtered$lat) - 10,
                                               max(track_filtered$lat) + 10),
                                      output_crs = gfw_projections('Equal Earth')$proj)

sf::sf_use_s2(FALSE)
# generate new plot using `bounding_box_man`. 
fishing_track_review(track_df = track_filtered,
                     bounding_box_man = bounding,
                     gfw_proj_name = 'Equal Earth',  # must be the same as the bounding box
                     color_fishing = TRUE,
                     globe_location = 'upperright',
                     theme = 'dark',
                     time_series_labels = NA,
                     vessel_name = 'TUNAQUEEN')
```
 
----- Vessel Info Questions---

Question 1. What is the name, callsign, flag state, and imo of the vessel with mmsi  353154000 during 2018?

Answer: Shipname:CABO DE PALOS, Callsign: HP5179, IMO: 7363700

```{r Question 1}
v_info_year <- glue::glue("SELECT
 ssvid, best_flag, callsign, vessel_class, shipname.value AS shipname, imo, year
FROM (
  SELECT
    ssvid,
    best.best_flag as best_flag,
    best.best_vessel_class as vessel_class,
   ais_identity.n_imo_mostcommon.value as imo,
    ais_identity.shipname_mostcommon as shipname,
 ais_identity.n_callsign_mostcommon as callsign,
    year
FROM
    `gfw_research.vi_ssvid_byyear_v20210706`)

WHERE CAST(year AS STRING) = '2018'

AND ssvid= '353154000'

")


v_info_year<- gfw_query(query = v_info_year, run_query = TRUE, con = con)

v_info_year<- v_info_year$data

v_info_year

```

Question 2. Is the above answer different if you pull from the vessel info table (gfw_research.vi_ssvid_v) versus the vessel registry table (vessel_database.all_vessels_v)?

ANSWER: Using (gfw_research.vi_ssvid_v) -- Shipname:KING BEANS, Callsign: 3FK06, IMO: 7363700
        Using (vessel_database.all_vessels_v) -- if we look at timestamp of activity and look for 2018 activity the information coincides with the by_year table. This is also true for gfw_research.vi_ssvid_v if I would have use ais_identity but without most common and then checked timestamp of the activity for 2018.
        
```{r}
v_info <- glue::glue("SELECT
 ssvid, best_flag, callsign, vessel_class, shipname.value AS shipname, imo, 
FROM (
  SELECT
    ssvid,
    best.best_flag as best_flag,
    best.best_vessel_class as vessel_class,
   ais_identity.n_imo_mostcommon.value as imo,
    ais_identity.shipname_mostcommon as shipname,
 ais_identity.n_callsign_mostcommon as callsign,
 on_fishing_list_best
 
FROM
    `gfw_research.vi_ssvid_v20210706`)


WHERE ssvid= '353154000'
")


v_info<- gfw_query(query = v_info, run_query = TRUE, con = con)

v_info<- v_info$data

v_info

v_registry <- glue::glue("SELECT
 ssvid, best_flag, callsign, shipname, imo, first_timestamp,
   last_timestamp, geartype
FROM (
  SELECT
    identity.ssvid as ssvid,
    identity.flag as best_flag,
    identity.imo as imo,
     identity.n_shipname as shipname,
  identity.n_callsign as callsign,
a.first_timestamp,
a.last_timestamp,
r.geartype as geartype
FROM
    `vessel_database.all_vessels_v20210601`
    
LEFT JOIN UNNEST (activity) as a
LEFT JOIN UNNEST (registry) as r)

WHERE ssvid= '353154000'




")


v_registry<- gfw_query(query = v_registry, run_query = TRUE, con = con)

v_registry<- v_registry$data

v_registry


```

Question 3. Should you use gfw_research.vi_ssvid_v or gfw_research.vi_ssvid_byyear_v to answer question 1 in the vessel info section?

Answer: gfw_research.vi_ssvid_byyear_v would be safer but still good to check the how identity changed looking at first and last timestamp in the gfw_research.vi_ssvid_v if we are investigating a single vessel.


Question 4. Is the vessel considered a ‘carrier’? 

Nope, the vessel is considered a supply_vessel - support vessel

Question 5.Is the vessel a fishing vessel? What are different ways you could determine if the vessel was a fishing vessel? 

Answer:Nope,CABO DE PALOS does not look like a fishing vessel to me. When determine this we can first, check if is_on_fishing_list_best in the gfw_research.vi_ssvid_v, then we can check the registry gear, and finally we can look at picture of the vessel online by typing the ais number in any online search engine. 


Question 6. What is considered based on the best vessel class? Does this differ from what it is considered when looking at vessel_database.all_vessels_v?

Answer: Based on the best_vessel class the vessel is considered a cargo whereas when looking at vessel_database.all_vessels_v the vessel is considered a supply vessel


Question 7. Was the vessel ‘authorized’ by any RFMO during 2018? If so, which ones and what are the registry periods?


Answer: Yes the vessel was authorized under ICCAT in 2018. Regstry periods are are shown in the reg_check final table below. Interesting that shipname for 2018 was alternated with EVEREST in the ICCAT registry. 

```{r}
reg_check <- glue::glue("SELECT
 ssvid, best_flag, callsign, shipname, imo,  geartype, reg_list_uvi, authorized_from, authorized_to
FROM (
  SELECT
    identity.ssvid as ssvid,
    identity.flag as best_flag,
    identity.imo as imo,
     identity.n_shipname as shipname,
  identity.n_callsign as callsign,
  SAFE_CAST( SPLIT(list_uvi, '-')[OFFSET(0)] AS string) AS reg_list_uvi,
r.geartype as geartype,
r.authorized_from,
r.authorized_to,

FROM
    `vessel_database.all_vessels_v20210601`
    
LEFT JOIN UNNEST (registry) as r)

WHERE ssvid= '353154000'
and authorized_from is not null

GROUP BY 
ssvid, best_flag, callsign, shipname, imo,  geartype, reg_list_uvi, authorized_from, authorized_to

ORDER BY authorized_from

")


reg_check<- gfw_query(query = reg_check, run_query = TRUE, con = con)

reg_check<- reg_check$data

reg_check
```


--- Fishing ispection Questions---

Questions 1. We may also want to know about fishing. Plot a map of the track and fishing points by the vessel with the MMSI 367650000 between March 1 2017 and March 5 2017. Are there any issues with the track?

Answer: 98.87 Fishing hours between March 1 and 5 2017 

```{r}
vessel_track <- glue::glue("SELECT 
ssvid,
lon,
lat,
timestamp,
speed_knots, 
-1 * elevation_m AS depth_m,
distance_from_shore_m/1000 AS distance_from_shore_km,
nnet_score,
hours
FROM
`gfw_research.pipe_v20201001_fishing` 
WHERE seg_id IN (
SELECT seg_id 
FROM `gfw_research.pipe_v20201001_segs` 
WHERE 
overlapping_and_short IS FALSE AND 
good_seg IS TRUE) AND
ssvid = '367650000' AND
_partitiontime BETWEEN TIMESTAMP('2017-03-01') AND TIMESTAMP('2017-03-05') AND
nnet_score IS NOT NULL
ORDER BY timestamp")


vessel_track<- gfw_query(query = vessel_track, run_query = TRUE, con = con)

vessel_track<-vessel_track$data

fishing_track_review(track_df = vessel_track,
                     color_fishing = TRUE,
                     globe_location = 'lowerright',
                     time_series_labels = c('speed_knots','depth_m','distance_from_shore_km'),
                     vessel_name = 'ALASKA ENDEAVOR')


vessel_track  %>% select(hours,nnet_score) %>% filter(nnet_score>0.5) %>% summarize(sum(hours))
```




--- Port Visits Questions---

1. How many voyages did Tuna Queen have in 2018 based on a port visit confidence of 4? 

- 29 voyages (using the proto_voyages_c4)

2.How does this number change if you restrict the confidence to at least 2 or  at least 3 compared to confidence of 4? Why does it change?

- 30 voyages (using the proto_voyages_c2) It slightly increase (one voyages more) as confidence 2 means that the vessel  only has a a gap or a stop and not an entry/exit to be considered a port visit whereas with 4 it should have an entry, a stop or a gap and an exit.


```{r}
voyages_tuna_queen <- fishwatchr::gfw_query(query = here::here('queries','voyages_by_mmsi.sql'),
                                        run_query = TRUE,
                                        con = con)$data

```


3.How many port events occurred in the port visit associated with the voyage that ended in Zadar on January 20, 2018?

1 - port entry

```{r}
port_events_tuna_queen <- fishwatchr::gfw_query(query = here::here('queries','port_events_by_mmsi.sql'),
                                        run_query = TRUE,
                                        con = con)$data
```

